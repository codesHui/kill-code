<!DOCTYPE html>
<!--<#include "comm.ftl" /><#include "icrmNav.ftl"/><@doctype />  -->
<html>
<head>
<meta charset="utf-8">
<title>信息上报</title>
<!--<@cssJs /> -->
<style type="text/css">
*+html .leftbox .titlename{margin-right:-3px}/* IE7 */ 
*+html  .input_div{ /* background-color: olive; */padding: 0px;text-align: left;}/* IE7 */ 
.yijinav  a{
text-decoration: none;color: #3F3F3F;
}
.nav_off{
display: none;
}

.acitve {
  background-color: rgb(230, 227, 227);
  color: #3C9CD3;
}

<style type="text/css">  
        table {  
            border: #888FEA 1px solid;  
            border-spacing: 0px;  
            text-align: center;  
        }  
        th, tr, td {  
            border: #888FEA 1px solid;  
        }  
        th {  
            background-color: #98AEFD;  
        }  
        #id {  
            width: 40px;  
        }  
        #c1 {  
            width: 150px;  
        }  
    </style>  

<script type="text/javascript" src="<@s.url '/resources/js/jquery-1.4.2.js'/>"></script>
<script type="text/javascript" src="<@s.url '/resources/js/ajaxfileupload.js'/>"></script>
</head>
<body>
	<!--<@logonTop user="${userNickName}" />-->
	<!-- <@icrmnav title="信息管理"  second="信息上传"/> -->
	<div id="reportPolicy" class="reportPolicy" align="center" style="display: block;height: 520px;"> 
		<div class="reportArea">
			<div class="float_left leftbox" style="margin-left: 25px;" >
				<div class="hangstyle margin_top_25">
					<div class="float_left titlename">导入模板下载:</div>
					<div class="input_div" style="width: 300px;">
						<button  class="btn06" id="downloadModel">下&nbsp;载</button>
					&nbsp;&nbsp;&nbsp;&nbsp;
						<button  class="btn06" id="downloadDesc">填写说明</button>
					</div>
				</div>
				<div class="hangstyle">
					<div class="float_left titlename">选取文件:</div>
					<div style="width: 300px;margin-left:110px;">
 						<input type="file" name="reportPolicyFile" id="reportPolicyFile" />
					</div>
				</div>
				<div class="hangstyle">
					<div class="float_left titlename">上传结果:</div>
					<div style="width: 400px;" id="policy_upload_tiShi">
						<label id="fileUploadProcess"></label>
						<div class="float_rifht margin_left_85" style="display:none; margin-left:" id="downloadWrong">
							<button class="btn05" id="downWrong">下载表格</button>
						</div>
					</div>
				</div>
				<div class="hangstyle">
					<div class="float_left titlename"></div>
					<div style="width: 300px;" id="policy_upload_tiShi">
						<button class="btn03" type="button" id="reportSubmit" >确&nbsp;认&nbsp;上&nbsp;传</button>
					</div>
				</div>
			</div>
			<!-- 上传轨迹列表展示 -->
			<div class="float_left leftbox" style="margin-top:80px;margin-left:35px;" id="historyShow">
			    <div style="padding: 10px;background: #efefef;font-size: 18px;color: #333;">上传历史</div>
				   <div style="max-height: 200px;overflow-y: auto;" >
				    <table style="text-align:center;border:1px;background: #fff;color: #333;" id="historyLstShow"> 

				    </table>
				    </div>
			</div>
		</div>
	</div>
	<div class="fisrt_bottom_xian"></div>
	<!--<#include "ufoot.html"/><!--尾部结束-->

<script type="text/javascript">

var uploadProcessTimer = null;  

//获取文件上传进度  
function getFileUploadProcess() {  
	document.getElementById("downloadWrong").style.display="none";
    $.get("<@s.url '/icrm/policy/reportPolicy'/>", function(data) {  
    });  
}  
function getPolicyHistory(){
	document.getElementById("historyShow").style.display="none";
	$.ajax({
		type : "post",
        url : "<@s.url '/icrm/policy/getPolicyHistory'/>",
        dataType : "json",
        success : function(data) {
        	if(data.success)
			{
        		 $("#historyLstShow").html("");
        	   document.getElementById("historyShow").style.display="block";
        	   //$("#historyLstShow").append("<table style='margin: -2px -2px -2px -2px; width: 100%; border: 0px'>");
	            $("#historyLstShow").append("<tr>  <td width='180px' style='padding: 8px 0;'>时间</td><td width='210px'>文件名</td><td width='100px'>状态</td>  </tr>  "); 
        	   for(var i =0;i<data.data.length;i++){
	        	   var dic=data.data[i].split("|");
	        	  /*  $("#historyLstShow").append("<tr><td style='padding: 8px 0;'>"+dic[0]+"</td><td>"+dic[1]+"</td>");
	        	   $("#historyLstShow").append("<td style='padding: 8px 0;'>"+dic[0]+"</td>"); 
	        	   $("#historyLstShow").append("<td>"+dic[1]+"</td>");  */
	        	   if("成功" == dic[2]){
	        		   $("#historyLstShow").append("<tr><td style='padding: 8px 0;'>"+dic[0]+"</td><td>"+dic[1]+"</td><td style='color:green'>"+dic[2]+"</td></tr>"); 
	        	   }else{
	        		   $("#historyLstShow").append("<tr><td style='padding: 8px 0;'>"+dic[0]+"</td><td>"+dic[1]+"</td><td style='color:red'>"+dic[2]+"</td></tr>"); 
	        	   }
	        	   
	        	 /*   $("#historyLstShow").append("</tr>");  */
	      
	           } 
			}else{
				document.getElementById("historyShow").style.display="none";
			}
        	//遍历所有td中的值
        	
        	
        }
	});	
}

$(function () {
	//展示历史信息
	getPolicyHistory();

    $("#reportSubmit").click(function () {
    	$('#fileUploadProcess').html("");
    	document.getElementById("downloadWrong").style.display="none";
    	if ($("#reportPolicyFile").val().length > 0) {
    		 //设置加载图标的显示  
            uploadProcessTimer = window.setInterval(getFileUploadProcess, 20);  
    		//弹出框
            ajaxFileUpload();
    	}else{
    		$('#fileUploadProcess').html("请选择上传文件!");
    	}
    });
    
    $("#downloadModel").click(function () {
    	self.location.href="<@s.url '/icrm/downloadModel'/>";
    });
    
	$("#downloadDesc").click(function () {
		self.location.href="<@s.url '/icrm/downloadDesc'/>";
    });
	
	$("#downWrong").click(function () {
		self.location.href="<@s.url '/icrm/downloadWrong'/>";
    });
    
});
function ajaxFileUpload() {
    $.ajaxFileUpload({
            url: "<@s.url '/icrm/policy/reportPolicy'/>", //用于文件上传的服务器端请求地址
            secureuri: false, //是否需要安全协议，一般设置为false
            fileElementId: 'reportPolicyFile', //文件上传域的ID
            dataType: 'json', //返回值类型 一般设置为json
            async : false,
            success: function (data, status)  //服务器成功响应处理函数
            {  
            	getPolicyHistory();
            	document.getElementById("downloadWrong").style.display="none";
            	//清除定时器  
                if(uploadProcessTimer) {  
                    window.clearInterval(uploadProcessTimer);  
                }
                if(data['success']) { 
                	$('#fileUploadProcess').html("操作成功!");
                	/* setTimeout(function(){  //使用  setTimeout（）方法设定定时2000毫秒
                		window.location.reload();//页面刷新
                	},3000); */
                }else
                {   
                	if(data['msg'] == 'fileTypeWrong'){
	               		$('#fileUploadProcess').html("文件格式不正确");
	               	}
                	if(data['msg'] == 'sheetNameWrong'){
	               		$('#fileUploadProcess').html("信息上报表格与模板的表名不一致");
	               	}
                	if(data['msg'] == 'sheetNumWrong'){
	               		$('#fileUploadProcess').html("信息上报表格与模板的表数量不一致");
	               	}
                	if(data['msg'] == 'exception'){
                		$('#fileUploadProcess').html("信息上报出现异常，请重新上传...");
	               	}
                	if(data['code'] == '0'){
                		$('#fileUploadProcess').html("上传失败,请验证数据后,重新上传");
                		document.getElementById("downloadWrong").style.display="block";
                	}
                }
 
            },
            error: function (data, status, e)//服务器响应失败处理函数
            {
            	getPolicyHistory();
            	if(uploadProcessTimer) {  
                    window.clearInterval(uploadProcessTimer);  
                } 
            	document.getElementById("downloadWrong").style.display="none";
                //这里处理的是网络异常，返回参数解析异常，DOM操作异常  
                $('#fileUploadProcess').html("上传发生异常,请联系管理员");  
            }
        }
    )
    return false;
}
</script>

</body>
</html>